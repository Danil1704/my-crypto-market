<p-drawer [(visible)]="drawerVisible" [closable]="false">
  <ng-template #header>
    <div class="flex items-center gap-2">
      <span class="font-bold">CRAPPO</span>
    </div>
  </ng-template>
  <ul class="list-none p-0 m-0 overflow-hidden">
    <li>
      <a href="/register">
        <i class="pi pi-user-plus mr-2"></i>
        <span class="font-medium">Registration</span>
      </a>
      <a href="/login">
        <i class="pi pi-sign-in mr-2"></i>
        <span class="font-medium">Login</span>
      </a>
      <a href="#">
        <i class="pi pi-briefcase mr-2"></i>
        <span class="font-medium">My Briefcase</span>
      </a>
      <a href="/my-page">
        <i class="pi pi-home mr-2"></i>
        <span class="font-medium">Home</span>
      </a>
      <a href="/notes">
        <i class="pi pi-list mr-2"></i>
        <span class="font-medium">To Do List</span>
      </a>
      <a href="/analytics-dashboard">
        <i class="pi pi-database mr-2"></i>
        <span class="font-medium">Dashboard</span>
      </a>
      <a href="/signals-portfolio">
        <i class="pi pi-dollar mr-2"></i>
        <span class="font-medium">Portfolio</span>
      </a>
    </li>
  </ul>
  <ng-template #footer>
    <div class="flex items-center gap-2">
      <button pButton label="Account" icon="pi pi-user" class="w-full" outlined></button>
      <button
        pButton
        label="Logout"
        icon="pi pi-sign-out"
        class="w-full"
        severity="danger"
        text
      ></button>
    </div>
  </ng-template>
</p-drawer>
<button pButton (click)="drawerVisible = true" icon="pi pi-list"></button>

<p-button class="ml-4" (click)="showDialog()" label="About us" />
<p-dialog
  header="CRAPPO"
  [(visible)]="dialogVisible"
  [modal]="true"
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [style]="{ width: '50vw' }"
  [draggable]="false"
  [resizable]="false"
>
  <p>
    CRAPPO - an innovative company specializing in cryptocurrency and blockchain technology
    solutions. Our mission is to make digital finance simple, secure, and accessible to everyone. We
    create and develop products that allow users to conveniently manage their digital assets,
    conduct instant transactions, and take advantage of all the benefits of a decentralized economy.
    Transparency, security, and technological excellence are at the core of our work.
  </p>
</p-dialog>

<div class="title-wrapper">
  <div class="p-d-flex p-flex-column p-ai-center p-mt-5 p-gap-3">
    <div class="search-wrapper">
      <h1>CoinMarket</h1>
      <div class="search-input">
        <span>
          <i class="pi pi-search"></i>
          <input
            pInputText
            type="text"
            placeholder="Найти монету"
            [(ngModel)]="searchText"
            (input)="searchCoin()"
          />
        </span>
      </div>
      <div class="table-wrapper">
        <p-table
          [value]="filteredCoints"
          [paginator]="true"
          [rows]="10"
          [responsiveLayout]="'scroll'"
          style="width: 100%; max-width: 100%"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Price</th>
              <th>24h Change</th>
              <th>Volume</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-coin let-i="rowIndex">
            <tr>
              <td>{{ i + 1 }}</td>
              <td>
                <img [src]="coin.image" alt="{{ coin.name }}" style="width: 2rem" class="me-2" />
                {{ coin.name }}
                <span class="text-muted text-uppercase ms-2">{{ coin.symbol }}</span>
              </td>
              <td>{{ coin.current_price | number : '1.2-4' }}</td>
              <td [ngClass]="coin.price_change_percentage_24h > 0 ? 'text-success' : 'text-danger'">
                {{ coin.price_change_percentage_24h | number : '1.2-2' }}%
              </td>
              <td>{{ coin.total_volume | number : '1.0-0' }}</td>
              <td>
                <p-button
                  label="Добавить"
                  icon="pi pi-plus"
                  styleClass="p-button-sm p-button-success"
                  (onClick)="openNew(coin)"
                >
                </p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Портфель -->
    <div class="p-m-4 p-w-100">
      <h2 class="text-center pt-5">Мой портфель</h2>
      <p-button
        label=""
        icon="pi pi-plus"
        styleClass="p-button-success p-ml-2"
        (onClick)="displayDialog = true"
      ></p-button>
      <p-table class="pt-5" [value]="portfolio" [responsiveLayout]="'scroll'">
        <ng-template pTemplate="header">
          <tr>
            <th>Coin</th>
            <th>Amount</th>
            <th>Buy Price</th>
            <th>Current Price</th>
            <th>Total Value</th>
            <th>P/L ($)</th>
            <th>P/L (%)</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <!-- Колонка с иконкой и названием -->
            <td class="coin-cell">
              <img [src]="item.image" alt="{{ item.name }}" class="coin-icon" />
              <span>{{ item.name }} ({{ item.symbol.toUpperCase() }})</span>
            </td>

            <td>{{ item.amount }}</td>
            <td>{{ item.buyPrice | number : '1.0-0' }}</td>
            <td>{{ item.currentPrice | number : '1.0-0' }}</td>
            <td>{{ item.amount * (item.currentPrice || item.buyPrice) | number : '1.0-0' }}</td>

            <td
              [ngClass]="item.profitLoss && item.profitLoss >= 0 ? 'text-success' : 'text-danger'"
            >
              {{ item.profitLoss | number : '1.0-0' }}
            </td>

            <td
              [ngClass]="
                item.profitLossPercent && item.profitLossPercent >= 0
                  ? 'text-success'
                  : 'text-danger'
              "
            >
              {{ item.profitLossPercent | number : '1.2-2' }}%
            </td>

            <!-- Новая колонка 24h Change -->
            <td [ngClass]="item.price_change_percentage_24h >= 0 ? 'text-success' : 'text-danger'">
              {{ item.price_change_percentage_24h | number : '1.2-2' }}%
            </td>

            <td>
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-sm p-button-warning p-mr-2"
                (click)="editItem(item)"
              ></button>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-sm p-button-danger"
                (click)="deleteItem(item)"
              ></button>
            </td>
          </tr>
        </ng-template>

        <!-- Итог -->
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="4" class="text-right"><strong>Итого:</strong></td>
            <td>
              <strong>{{ totalValue | number : '1.0-0' }}</strong>
            </td>
            <td [ngClass]="totalProfitLoss >= 0 ? 'text-success' : 'text-danger'">
              <strong>{{ totalProfitLoss | number : '1.0-0' }}</strong>
            </td>
            <td [ngClass]="totalProfitLossPercent >= 0 ? 'text-success' : 'text-danger'">
              <strong>{{ totalProfitLossPercent | number : '1.2-2' }}%</strong>
            </td>
            <td></td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Диалог добавления/редактирования -->
    <p-dialog
      header="{{ editing ? 'Редактировать' : 'Добавить' }} в портфель"
      [(visible)]="displayDialog"
      [modal]="true"
      [style]="{ width: '400px' }"
    >
      <div class="p-fluid">
        <div class="p-field">
          <label>Amount</label>
          <input type="number" pInputText [(ngModel)]="newItem.amount" />
        </div>
        <div class="p-field">
          <label>Buy Price</label>
          <input type="number" pInputText [(ngModel)]="newItem.buyPrice" />
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button
          label="Cancel"
          icon="pi pi-times"
          class="p-button-text"
          (click)="displayDialog = false"
        ></p-button>
        <p-button label="Save" icon="pi pi-check" (click)="saveItem()"></p-button>
      </ng-template>
    </p-dialog>
  </div>
</div>
